{% extends "admin/base_site.html" %}

{% block extrastyle %}
{{ block.super }}
<style>
  /* Light-mode defaults on the wrapper, same idea as .dashboard-container */
  .doc-tool-wrapper {
    --doc-bg: #ffffff;
    --doc-card-bg: #ffffff;
    --doc-border: #e5e7eb;
    --doc-text: #111827;
    --doc-muted: #6b7280;
    --doc-button-bg: #2563eb;
    --doc-button-text: #ffffff;

    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
    color: var(--doc-text);
  }

  /* Dark-mode overrides driven by admin theme classes, like dashboard.html */
  html.dark .doc-tool-wrapper,
  body.dark .doc-tool-wrapper,
  [data-theme="dark"] .doc-tool-wrapper {
    --doc-bg: transparent;
    --doc-card-bg: #111827;  /* gray-900 */
    --doc-border: #374151;   /* gray-700 */
    --doc-text: #f9fafb;     /* gray-50 */
    --doc-muted: #9ca3af;    /* gray-400 */
    --doc-button-bg: #2563eb;
    --doc-button-text: #f9fafb;
  }

  .doc-tool-title {
    margin: 0 0 16px;
    font-size: 22px;
    font-weight: 600;
    color: var(--doc-text);
  }

  .doc-tool-card {
    background: var(--doc-card-bg);
    padding: 30px;
    border-radius: 8px;
    border: 1px solid var(--doc-border);
    box-shadow: 0 2px 10px rgba(15,23,42,0.08);
  }

  .doc-tool-label {
    display: block;
    font-weight: 600;
    margin-bottom: 5px;
    color: var(--doc-text);
  }

  .doc-tool-input,
  .doc-tool-textarea {
    width: 100%;
    padding: 8px;
    border-radius: 4px;
    border: 1px solid var(--doc-border);
    background: var(--doc-bg);
    color: var(--doc-text);
  }

  .doc-tool-input::placeholder,
  .doc-tool-textarea::placeholder {
    color: var(--doc-muted);
  }

  .doc-tool-button {
    padding: 10px 20px;
    font-size: 16px;
    background: var(--doc-button-bg);
    color: var(--doc-button-text);
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
</style>
{% endblock %}

{% block content %}
<div class="doc-tool-wrapper">
    <h1 class="doc-tool-title">Generate: {{ template_conf.name }}</h1>

    <form method="post" class="doc-tool-card">
        {% csrf_token %}

        <h3 style="margin-top: 0;">1. Manual Details</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
            {% for field in manual_fields %}
                <div>
                    <label class="doc-tool-label">{{ field.label }}</label>
                    {% if field.type == 'textarea' %}
                        <textarea name="{{ field.key }}" rows="6"
                                  class="vTextField richtext doc-tool-textarea">{{ field.initial|default_if_none:"" }}</textarea>
                    {% else %}
                        <input type="{{ field.type|default:'text' }}" name="{{ field.key }}"
                               class="vTextField doc-tool-input"
                               value="{{ field.initial|default_if_none:"" }}">
                    {% endif %}
                </div>
                {# After the last personal info field (mobile), insert a full-width break #}
                {% if field.key == 'mobile' %}
                    <div style="grid-column: 1 / -1; height: 1px; background-color: var(--doc-border); margin: 8px 0 0;"></div>
                {% endif %}
            {% endfor %}
        </div>

        <div style="margin-top: 30px; text-align: right;">
            <button type="submit" class="button doc-tool-button">
                Generate &amp; Print üñ®Ô∏è
            </button>
        </div>
    </form>

    <!-- WYSIWYG editor (TinyMCE) for all textarea.richtext fields -->
    <script src="https://cdn.tiny.cloud/1/{{ tinymce_api_key }}/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
    <script>
      (function() {
        function getCookie(name) {
          const value = '; ' + document.cookie;
          const parts = value.split('; ' + name + '=');
          if (parts.length === 2) return parts.pop().split(';').shift();
        }

        tinymce.init({
          selector: 'textarea.richtext',
          height: 260,
          menubar: false,
          plugins: 'lists link image table autoresize',
          toolbar: 'undo redo | bold italic underline | bullist numlist | alignleft aligncenter alignright | link image',
          branding: false,
          images_upload_url: '/tools/upload-image/',
          automatic_uploads: true,
          images_upload_credentials: true,
          setup: function (editor) {
            editor.on('change', function () {
              editor.save();
            });
          },
          images_upload_handler: function (blobInfo, success, failure) {
            const xhr = new XMLHttpRequest();
            xhr.withCredentials = true;
            xhr.open('POST', '/tools/upload-image/');
            const csrftoken = getCookie('csrftoken');
            if (csrftoken) {
              xhr.setRequestHeader('X-CSRFToken', csrftoken);
            }
            xhr.onload = function() {
              if (xhr.status !== 200) {
                failure('HTTP Error: ' + xhr.status);
                return;
              }
              const json = JSON.parse(xhr.responseText);
              if (!json || typeof json.location !== 'string') {
                failure('Invalid JSON: ' + xhr.responseText);
                return;
              }
              success(json.location);
            };
            const formData = new FormData();
            formData.append('file', blobInfo.blob(), blobInfo.filename());
            xhr.send(formData);
          }
        });
      })();
    </script>
</div>
{% endblock %}
